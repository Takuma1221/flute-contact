# 管理機能詳細ガイド

## 概要

フルートライブ予約システムには、ライブ情報やキャンセルポリシーを動的に管理できる管理画面が実装されています。

## 管理画面へのアクセス

**URL**: `/admin`  
**認証方法**: 環境変数 `ADMIN_PASSWORD` で設定されたパスワード

## 実装された管理機能

### 1. ライブ情報管理

#### 編集可能な項目

- **ライブ日程**: 日付の入力
- **開演時間1**: 1回目公演の開始時間
- **開演時間2**: 2回目公演の開始時間（任意）
- **会場情報**: 会場名や詳細
- **会場住所**: 住所情報（任意）
- **一般料金**: チケット価格（数値）
- **学生料金**: 学生向けチケット価格（数値）
- **配送料**: チケット郵送時の送料（数値）
- **最大チケット枚数**: 1回の予約で購入可能な最大枚数
- **備考・注意事項**: 自由記述（任意）

### 2. キャンセルポリシー管理

#### 新機能として追加

- **キャンセル期限（日前）**: 何日前までキャンセル可能かを数値で設定
  - 0の場合: キャンセル不可
  - 1以上の場合: 指定日数前まで無料キャンセル可能
- **キャンセルポリシー**: 自由記述でキャンセル規約を設定
  - 改行対応（`\n`で改行）
  - 現金払いの場合の注意事項なども含められる

### 3. パンフレット画像管理

#### アップロード機能

- **対応形式**: JPG, PNG, WebP
- **最大サイズ**: 5MB
- **処理方式**: Base64エンコーディング
- **保存場所**: JSONファイル内にBase64データとして保存
- **表示**: 公開ページで自動反映、クリックで拡大表示

#### キャッシュバスティング

- 画像更新時にタイムスタンプを自動付与
- ブラウザキャッシュを回避して最新画像を表示

## API仕様

### 管理画面認証 API

- **エンドポイント**: `/api/admin/auth`
- **メソッド**: POST
- **認証方式**: Bearer Token（`Bearer flute2025admin`）

### ライブ情報管理 API

- **GET `/api/admin/live-info`**: 現在の設定を取得
- **POST `/api/admin/live-info`**: 設定を更新

### ステータス監視 API

- **GET `/api/admin/status`**: システムの動作状況確認
- **レスポンス例**:

```json
{
  "status": "ok",
  "timestamp": "2025-09-22T10:30:00.000Z",
  "services": {
    "database": "connected",
    "email": "configured",
    "sheets": "connected"
  }
}
```

## データ保存形式

### ファイル保存

- **保存場所**: `data/live-info.json`
- **フォーマット**: JSON
- **バックアップ**: 自動的にタイムスタンプ付きで更新

### データ構造例

```json
{
  "liveDate": "2025年10月4日（土）",
  "liveTime1": "14:00",
  "liveTime2": "18:00",
  "venue": "東京都内コンサートホール",
  "venueAddress": "東京都渋谷区...",
  "generalPrice": 4000,
  "studentPrice": 3000,
  "deliveryFee": 200,
  "maxTickets": 10,
  "notes": "特別な注意事項",
  "programImageUrl": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
  "cancelPolicy": "お客様都合によるお申込み後のキャンセルおよび返金はお受けしておりません。\nなお、当日現金払いを選択されたお客様でご来場いただけなかった場合には、お手数ですが お振込み下さいますようお願いいたします。",
  "cancelDeadlineDays": 0,
  "updatedAt": "2025-09-22T10:30:00.000Z",
  "lastUpdated": "2025-09-22T10:30:00.000Z"
}
```

## リアルタイム反映

### 実装方式

- **キャッシュバスティング**: タイムスタンプクエリパラメータ使用
- **更新確認**: APIアクセス時に `t=${Date.now()}` を付与
- **表示更新**: 管理画面での変更が公開ページに即座に反映

### 対象項目

- ライブ日程の選択肢
- 料金表示
- キャンセルポリシーの表示
- パンフレット画像

## セキュリティ

### 認証

- 環境変数によるパスワード認証
- ローカルストレージでの認証状態管理
- API レベルでの認証チェック

### データ保護

- 画像データの適切なエンコーディング
- 入力値のサニタイゼーション
- ファイルアップロード時のサイズ制限

## トラブルシューティング

### よくある問題

1. **画像が反映されない**
   - ブラウザキャッシュをクリア
   - タイムスタンプが更新されているか確認

2. **認証エラー**
   - 環境変数 `ADMIN_PASSWORD` の設定確認
   - ブラウザのローカルストレージクリア

3. **設定が保存されない**
   - `data` ディレクトリの書き込み権限確認
   - サーバーログでエラー内容確認

### デバッグ方法

- ブラウザ開発者ツールのコンソールでログ確認
- ネットワークタブでAPI通信状況確認
- サーバーログでバックエンド処理状況確認
